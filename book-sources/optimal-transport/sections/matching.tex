% !TEX root = ../CourseOT.tex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Optimal Matching between Point Clouds}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Monge Problem for Discrete Points}
\label{sec-monge-pbm}

%%%%%%%
\paragraph{Matching Problem}

Given a cost matrix $(\C_{i,j})_{i \in \range{n}, j \in \range{m}}$ and assuming $n=m$, the optimal assignment problem aims to find a bijection $\sigma$ within the set $\Perm(n)$ of permutations of $n$ elements that solves
\eql{\label{eq-optimal-assignment}
	\umin{\sigma \in \Perm(n)} \frac{1}{n}\sum_{i=1}^n \C_{i,\sigma(i)}.
}
One could naively evaluate the cost function above using all permutations in the set $\Perm(n)$. However, this set has size $n!$, which becomes enormous even for small values of $n$.
%
In general, the optimal $\sigma$ is not unique.


\paragraph{1D Case}

If the cost is of the form $\C_{i,j}=h(x_i-y_j)$, where $h: \RR \rightarrow \RR^+$ is convex (for example, $\C_{i,j}=|x_i-y_j|^p$ for $p \geq 1$), it follows that an optimal $\sigma$ necessarily defines an increasing map $x_i \mapsto y_{\sigma(i)}$, i.e.,
\eq{
	\forall (i,i'), \quad (x_i-x_{i'})(y_{\sigma(i)}-y_{\sigma(i')}) \geq 0.
}
Indeed, if this property is violated, i.e., there exists $(i,i')$ such that $(x_i-x_{i'})(y_{\sigma(i)}-y_{\sigma(i')}) < 0$, then one can define a permutation $\tilde{\sigma}$ by swapping the match, i.e., $\tilde{\sigma}(i)=\sigma(i')$ and $\tilde{\sigma}(i')=\sigma(i)$, yielding a better cost
\eq{
	\sum_i h(x_{i}-y_{\tilde{\sigma}(i)}) \leq \sum_i h(x_{i}-y_{\sigma(i)}),  
}
because
\eq{
	h(x_{i}-y_{\tilde\sigma(i')}) + h(x_{i'}-y_{\tilde\sigma(i)}) 
	\leq
	h(x_{i}-y_{\sigma(i)}) + h(x_{i'}-y_{\sigma(i')}).  
}
Therefore, the algorithm to compute an optimal transport is to sort the points, i.e., find some pair of permutations $\sigma_X, \sigma_Y$ such that
\eq{
	x_{\sigma_X(1)} \leq x_{\sigma_X(2)} \leq \ldots
	\qandq
	y_{\sigma_Y(1)} \leq y_{\sigma_Y(2)} \leq \ldots
}
and then an optimal match is mapping $x_{\sigma_X(k)} \mapsto y_{\sigma_Y(k)}$, i.e., an optimal transport is $\sigma = \sigma_Y \circ \sigma_X^{-1}$. The total computational cost is thus $O(n\log(n))$, using, for instance, the quicksort algorithm.
%
Note that if $\phi : \RR \rightarrow \RR$ is an increasing map, one can apply this technique to costs of the form $h(|\phi(x)-\phi(y)|)$ with a change of variable.
%
A typical application is the grayscale histogram equalization of the luminance of images.

Note that if $h$ is strictly convex, then all optimal assignement are increasing, so if the points are all distincts, there is a unique such increasing map. But if $h$ is not strictly convex, for instance $c(x,y)=|x-y|$ then there exists non increasing optimal assignement, for instance in the book shifting problem, with overlapping uniform distribution (the mass at the intesection can stay at the same place).

This efficient strategy to compute the OT in 1-D does not extend to higher dimensions. In 2-D, if the cost is $c(x,y) = \norm{x-y}$, then, as already noted by Monge, trajectories cannot cross, this is a consequence of the parallelogram inequality. However, this is not enough to uniquely determine an optimal matching. 

Note that if $h$ is concave instead of being convex, then the behavior is entirely different, and the optimal match tends to exchange the positions. In this case, there exists an $O(n^2)$ algorithm.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Matching Algorithms}

Efficient algorithms exist to solve the optimal matching problem. The most well-known are the Hungarian and the auction algorithm, which run in $O(n^3)$ operations. Their derivation and analysis, however, are greatly simplified by introducing the Kantorovich relaxation and its associated dual problem.
%
A typical application of these methods is equalizing the color palette between images, corresponding to a 3-D optimal transport.
